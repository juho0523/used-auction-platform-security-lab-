## Application-Aware Logging & Detection for Authentication Abuse (SQL Injection Context)

---

## 1. Purpose

This document describes the implementation of **application-aware security logging**
and **SIEM-based detection** introduced to address the detection gaps identified in
**AS-01 (SQL Injection Attempt & Detection Gap Analysis)**.

Although the tested SQL Injection attempts did not succeed due to secure coding practices,
the original system lacked sufficient security telemetry to:

- Observe malicious intent
- Classify authentication abuse
- Generate actionable SOC alerts

The objective of this phase is **not exploitation**, but **detection maturity**:
to ensure that failed attacks still generate meaningful, actionable signals.

---

## 2. Detection Problem Statement

### 2.1 Observed Limitations (From AS-01)

During SQL Injection testing against the authentication endpoint:

- Tomcat access logs contained only generic request metadata
- Application logs did not differentiate failure causes
- SQL Injection attempts appeared identical to benign login failures
- SIEM-side rule-based detection was not feasible

From a SOC perspective, the system was technically secure,
but **operationally blind**.

---

### 2.2 Detection Requirements

To address these limitations, the following detection capabilities were required:

- Application-layer awareness of authentication outcomes
- Structured, security-oriented logging
- Clear distinction between:
  - User error
  - Automated abuse (brute-force)
  - Input anomaly patterns (e.g., SQL meta-characters)
- Centralized correlation and alerting via Wazuh

---

## 3. Detection Architecture Overview
```
[User Request]
↓
[Tomcat / Application]
↓
[Security-Aware Application Logs]
↓
[Wazuh Agent (Windows)]
↓
[Wazuh Manager (Linux)]
↓
[Decoders → Rules → Alerts]
```


Detection logic is intentionally shifted **closer to the application layer**
to reduce ambiguity and avoid reliance on access logs or network-only signals.

---

## 4. Application-Level Security Logging

### 4.1 Modified Component

- Component: `LoginAction`
- Layer: Application (Controller)

The authentication handler was modified to emit
**structured, SOC-oriented security logs**
at the exact point where authentication outcomes are determined.

This ensures maximum semantic accuracy with minimal data exposure.

---

### 4.2 Logged Event Types

| Event | Description |
|------|-------------|
| AUTH_FAIL | Authentication failure with security context |
| AUTH_SUCCESS | Successful authentication |

---

### 4.3 Structured Log Format

Example log generated by the modified `LoginAction`:

```log
AUTH_FAIL ip=127.0.0.1 endpoint=/used-auction-platform/controller \
auth_fail_total=6 auth_level=HIGH auth_window_sec=30 \
input_len=3 input_type=ALPHANUM_SPECIAL suspicious_pattern=false \
reason=INVALID_CREDENTIAL
```
#### Field Semantics

| Field | Purpose |
|------|--------|
| ip | Source IP address |
| endpoint | Target application endpoint |
| auth_fail_total | Number of authentication failures observed within the defined window |
| auth_level | Application-side risk classification (LOW / HIGH) |
| auth_window_sec | Time window used for failure aggregation |
| input_len | Length of the user-controlled identifier |
| input_type | Character composition of the identifier |
| suspicious_pattern | Presence of SQL meta-characters |
| reason | High-level authentication failure category |

Raw credentials, request payloads, or SQL statements are intentionally excluded
to prevent sensitive data exposure while preserving detection value.

---

## 5. Application-Side Classification Logic

Authentication behavior is classified directly at the application layer
using a sliding time window implemented within the authentication controller (`LoginAction`).

The purpose of this logic is to emit **pre-classified security context**
rather than forcing the SIEM to reconstruct behavioral state from raw logs.

### 5.1 Classification Criteria

| Condition | auth_level |
|----------|------------|
| Fewer than 5 failures within 30 seconds | LOW |
| 5 or more failures within 30 seconds | HIGH |

The resulting `auth_level` is embedded directly in the security log entry
and serves as a primary detection signal for downstream analysis.

This approach deliberately avoids time-window correlation logic at the SIEM layer,
reducing complexity and false positives.

---

## 6. Wazuh Integration

### 6.1 Log Collection

- Application security logs are written to Tomcat daily rotating log files:
```
catalina.YYYY-MM-DD.log
```
- The Wazuh Windows Agent monitors the log directory rather than a static filename
- Log rotation does not interrupt ingestion
- Events are forwarded to the Wazuh Manager in near real time

This design ensures continuous visibility without operational fragility.

---

### 6.2 Decoder Design

Custom decoders were implemented to parse structured authentication logs.

Decoder strategy:

- Parent decoder matches authentication event type (`AUTH_FAIL`)
- Child decoders extract structured key-value fields
- Parsed values are mapped to Wazuh event fields for rule evaluation

This deterministic parsing model avoids brittle regex-heavy logic
and ensures consistent field extraction across log rotations.

---

### 6.3 Detection Rule

The detection strategy shifts from signature-based matching to **Behavioral Analysis**. By offloading the stateful correlation (e.g., failure frequency) to the application layer, the SIEM rules remain lightweight, deterministic, and highly accurate.

```xml
<group name="tomcat,authentication,">

  <rule id="100100" level="5">
    <match>AUTH_FAIL</match>
    <description>Tomcat login failed</description>
    <group>authentication_failed</group>
  </rule>

  <rule id="100101" level="12">
    <if_matched_sid>100100</if_matched_sid>
    <match>suspicious_pattern=true</match>
    <description>Possible SQL Injection attempt on Tomcat login</description>
    <mitre>
      <id>T1059</id>
    </mitre>
    <group>web_attack,sql_injection</group>
  </rule>

  <rule id="100102" level="10">
    <if_matched_sid>100100</if_matched_sid>
    <match>auth_level=HIGH</match>
    <description>Tomcat brute-force login detected (>=5 failures in 30s)</description>
    <mitre>
      <id>T1110.001</id>
    </mitre>
    <group>authentication_failed,bruteforce,credential_access</group>
  </rule>

  <rule id="100103" level="3">
    <match>AUTH_SUCCESS</match>
    <description>Tomcat login success</description>
    <group>authentication_success</group>
  </rule>

</group>
```
Strategic Implementation Highlights
- **Hierarchical Triggering (if_matched_sid)**: Rules 100101 and 100102 are dependent on the parent rule (100100). This hierarchical structure ensures that deep inspection only occurs when an AUTH_FAIL event is first identified, optimizing the Wazuh analysis engine's performance.
- **Application-Assisted Correlation**: Traditionally, SIEMs calculate brute-force attempts using frequency/time-window functions (e.g., frequency: 5, timeframe: 30). Here, the logic is handled by the application, which passes the auth_level=HIGH flag. This reduces SIEM CPU overhead and eliminates false positives caused by log ingestion delays.
- **Severity-Based Alerting**:
  - Level 12 (Critical): SQL Injection attempts are assigned a higher severity because they indicate a direct attempt to exploit application logic vulnerabilities.
  - Level 10 (High): Brute-force attacks represent high-volume credential probing and warrant immediate IP-reputation triaging.
- **MITRE ATT&CK Alignment**: Each high-severity rule is mapped to specific MITRE techniques (T1059, T1110.001). This allows the SOC team to integrate these alerts into a broader threat hunting framework and correlate them with other lateral movement signals.

## 7. Detection Results

### 7.1 Observable Signals

With application-aware logging and SIEM correlation in place,
the following security-relevant signals became observable
that were previously indistinguishable from normal authentication failures:

- Repeated authentication failures aggregated within a defined time window
- Application-side classification of high-risk authentication behavior (`auth_level=HIGH`)
- SQL Injection attempts that fail due to parameterized queries and input sanitization
- Behavioral patterns consistent with brute-force and credential probing
- Early-stage reconnaissance activity targeting authentication endpoints

Detection is no longer dependent on exploit success,
but on **observable attacker behavior**.

---

### 7.2 SOC Impact

From a SOC operations perspective,
the implemented logging and detection model significantly improves visibility
and reduces investigative uncertainty.

| Capability | Before | After |
|----------|--------|-------|
| SQL Injection visibility | None | High |
| Brute-force detection | Inconsistent | Reliable |
| Alert signal quality | Low | Actionable |
| Analyst workload | Manual log review | Rule-driven triage |
| Detection confidence | Low | High |
| Early warning capability | Absent | Present |

Authentication failures are no longer treated as operational noise,
but as security telemetry suitable for triage and escalation.

---

## 8. MITRE ATT&CK Mapping

Observed behaviors during this detection scenario
map to the following MITRE ATT&CK techniques:

| Tactic | Technique | ID |
|------|----------|----|
| Initial Access | Exploit Public-Facing Application | T1190 |
| Credential Access | Brute Force | T1110 |
| Reconnaissance | Active Scanning | T1595 |

Although no exploitation was successful,
the activity represents legitimate pre-compromise threat behavior
that warrants detection and monitoring.

---

## 9. Limitations and Future Work

### 9.1 Current Limitations

The current implementation has the following known limitations:

- Detection relies on explicit application-level instrumentation
- No correlation with reverse proxy, WAF, or CDN telemetry
- No automated active response or blocking configured
- Limited contextual enrichment (e.g., User-Agent, GeoIP)

These constraints were accepted intentionally
to prioritize detection clarity and reduce false positives
during initial implementation.

---

### 9.2 Planned Extensions

Planned enhancements include:

- **LD-02:** Cross-site scripting (XSS) detection using the same logging model
- Correlation with upstream proxy or WAF logs
- Risk-based alert escalation policies
- Temporary IP blocking or rate-limiting via active response
- Enrichment with threat intelligence and reputation data

The logging schema and detection logic were designed
to be reusable across multiple web attack classes.

---

## 10. Conclusion

This detection scenario demonstrates that
secure coding practices alone do not provide sufficient SOC visibility.

By introducing structured, application-aware security logging
and delegating correlation and alerting to the SIEM,
failed attacks become observable early-stage threat signals.

This approach enables proactive detection,
improves analyst confidence,
and establishes a scalable foundation
for expanding web application attack detection coverage.

---

## Evidence

All logs, configuration files, and validation artifacts
referenced in this document
are stored under the `evidence/` directory.
