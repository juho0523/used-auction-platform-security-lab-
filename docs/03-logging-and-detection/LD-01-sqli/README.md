# LD-01: Application-Aware Logging & Detection for SQL Injection Attempts

## 1. Purpose

This document describes the design and implementation of **application-aware security logging and detection**
to address the SQL Injection (SQLi) detection gaps identified in **AS-01**.

Although the tested SQL Injection attack did not succeed due to secure coding practices,
the absence of meaningful security context in existing logs prevented reliable detection,
classification, and alerting from a SOC perspective.

The objective of this implementation is **not exploitation**, but **detection maturity**:
to ensure that SQL Injection attempts can be *observed, classified, and escalated*
even when exploitation fails.

---

## 2. Detection Problem Statement

### 2.1 Observed Limitations (From AS-01)

During the SQL Injection testing scenario:

- Tomcat access logs recorded request metadata only
- Application logs did not distinguish authentication failure causes
- SQL Injection attempts appeared identical to benign login failures
- No rule-based or threshold-based detection was possible

From a SOC standpoint, the system was **secure but operationally blind**.

---

### 2.2 Detection Requirements

To reliably detect SQL Injection attempts during authentication,
the following capabilities were required:

- Application-layer awareness of authentication outcomes
- Structured logging with security-relevant fields
- Distinction between:
  - Normal user mistakes
  - Automated attacks
  - Input anomaly patterns
- Centralized correlation and alerting via SIEM (Wazuh)

---

## 3. Detection Architecture Overview
```
[User Request]
↓
[Tomcat / Application]
↓
[Security-Aware Application Logs]
↓
[Wazuh Agent (Windows)]
↓
[Wazuh Manager (Linux)]
↓
[Decoders → Rules → Alerts]
```

This approach intentionally shifts detection logic **closer to the application layer**
to avoid reliance on network-only or access-log-only signals.

---

### 3.2 Design Principles

- **Fail-safe logging**: Log only metadata and classifications, never raw secrets
- **Application context first**: The application understands intent better than the SIEM
- **SOC-oriented output**: Logs are designed for analysts, not developers
- **Extensibility**: The same pattern can be reused for XSS and other web attacks

---

## 4. Application-Level Security Logging Design

### 4.1 Logged Event Types

| Event | Description |
|-----|------------|
| AUTH_FAIL | Authentication failure with security context |
| AUTH_SUCCESS | Successful authentication |

---

### 4.2 Structured Log Format (SQLi-Relevant)

Example log generated by the application:

```log
AUTH_FAIL ip=127.0.0.1 endpoint=/used-auction-platform/controller \
auth_fail_total=6 auth_level=HIGH auth_window_sec=30 \
input_len=3 input_type=ALPHANUM_SPECIAL suspicious_pattern=false \
reason=INVALID_CREDENTIAL
```
#### Field Semantics

| Field | Purpose |
|------|--------|
| ip | Source IP address |
| endpoint | Target application endpoint |
| auth_fail_total | Number of authentication failures observed within the defined window |
| auth_level | Application-side risk classification (LOW / HIGH) |
| auth_window_sec | Time window used for failure aggregation |
| input_len | Length of the user-controlled identifier |
| input_type | Character composition of the identifier |
| suspicious_pattern | Presence of SQL meta-characters |
| reason | High-level authentication failure category |

> **Important**  
> Raw credentials, request payloads, or SQL statements are intentionally excluded from logs  
> to prevent sensitive data exposure while maintaining detection value.

---

## 5. Detection Strategy

### 5.1 Detection Logic Split

Detection responsibility is intentionally divided between layers:

| Layer | Responsibility |
|------|---------------|
| Application | Context awareness, behavioral classification, window-based aggregation |
| SIEM (Wazuh) | Correlation, alerting, and response orchestration |

This design avoids complex regex-heavy logic in SIEM rules  
and significantly reduces false positives caused by log ambiguity.

---

### 5.2 Application-Side Classification Logic

The application classifies authentication behavior using a sliding time window.

| Condition | auth_level |
|---------|------------|
| Fewer than 5 failures within 30 seconds | LOW |
| 5 or more failures within 30 seconds | HIGH |

This classification is emitted directly in the log stream  
and becomes a **primary detection signal** for the SIEM.

The SIEM does **not** attempt to reconstruct timing or state.

---

## 6. Wazuh Integration

### 6.1 Log Collection (Windows Agent)

- Tomcat logs are written to rotating files:
```
catalina.YYYY-MM-DD.log
```
- The Wazuh Windows agent monitors the **log directory**, not a fixed filename
- Daily log rotation does not interrupt log ingestion
- Application logs are forwarded in near real-time to the Wazuh Manager

---

### 6.2 Decoder Design

Custom decoders are used to parse structured authentication logs.

Decoder strategy:

- Parent decoder matches authentication event type (`AUTH_FAIL`)
- Child decoder extracts key-value fields
- Parsed values are mapped to Wazuh event fields for rule evaluation

This approach ensures deterministic parsing  
and avoids brittle pattern matching.

---

### 6.3 Detection Rules

Core detection rule for authentication abuse related to SQL Injection:

```xml
<rule id="100102" level="10">
<if_matched_sid>100100</if_matched_sid>
<match>auth_level=HIGH</match>
<description>Tomcat authentication abuse detected (SQL Injection or brute-force behavior)</description>
</rule>
```
This rule intentionally focuses on **behavioral abuse**
rather than specific SQL syntax.

As a result, obfuscated or sanitized payloads remain detectable.

## 7. Detection Outcome

### 7.1 Observable Attack Signals

With the enhanced application-level logging and SIEM correlation in place,
the system is now able to reliably observe and classify authentication abuse
that was previously invisible.

The following signals are now detectable:

- Repeated authentication failures within a short time window
- Authentication abuse classified at the application layer
- SQL Injection attempts that fail due to secure coding practices
- Behavioral patterns consistent with brute-force or credential probing
- Early-stage reconnaissance activity against authentication endpoints

Importantly, detection is no longer dependent on exploit success.

---

### 7.2 SOC Impact

| Capability | Before | After |
|----------|--------|-------|
| SQL Injection visibility | None | High |
| Brute-force detection | Inconsistent | Reliable |
| Detection confidence | Low | High |
| Alert quality | N/A | Actionable |
| Analyst workload | Manual log review | Rule-driven triage |
| Early warning capability | No | Yes |

From a SOC perspective, authentication failures are no longer treated
as generic noise, but as meaningful security telemetry.

---

## 8. MITRE ATT&CK Mapping

Detected behaviors map to the following MITRE ATT&CK techniques:

| Tactic | Technique | ID |
|------|----------|----|
| Initial Access | Exploit Public-Facing Application | T1190 |
| Credential Access | Brute Force | T1110 |
| Reconnaissance | Active Scanning | T1595 |

Although exploitation was unsuccessful,
the activity represents legitimate pre-compromise threat behavior
that warrants monitoring and response.

---

## 9. Limitations and Future Improvements

### 9.1 Current Limitations

- Detection depends on application-level instrumentation
- No correlation with web proxy, WAF, or CDN logs
- No automated active response enabled
- No enrichment using user-agent or geolocation data

These limitations are accepted as design trade-offs
to maintain clarity and reduce false positives in the initial implementation.

---

### 9.2 Planned Extensions

- **LD-02:** XSS detection using the same application-aware logging model
- Correlation with reverse proxy or WAF telemetry
- Risk-based alert escalation
- Temporary IP blocking or rate-limiting via active response
- Enrichment with threat intelligence and reputation data

The logging schema and detection logic were intentionally designed
to be reusable across multiple web attack classes.

---

## 10. Conclusion

This detection scenario demonstrates that
secure coding alone does not provide sufficient operational visibility.

By introducing structured, application-aware security logging
and delegating correlation and alerting to the SIEM,
the system achieves both precision and scalability.

Failed attacks are treated as early-stage threat signals,
enabling proactive detection and informed incident response.

This approach establishes a practical foundation
for expanding web attack detection coverage in subsequent scenarios.

---

## Evidence

All screenshots, logs, and configuration artifacts referenced in this document
are stored under the `evidence/` directory.



